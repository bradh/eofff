package net.frogmouth.rnd.eofff.gopro.gpmf;

import static org.testng.Assert.*;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.util.List;
import net.frogmouth.rnd.eofff.isobmff.Box;
import net.frogmouth.rnd.eofff.isobmff.ByteArrayParser;
import net.frogmouth.rnd.eofff.isobmff.OutputStreamWriter;
import org.testng.annotations.Test;

/** Unit test for GPMF. */
public class GPMFBoxTest {
    private static final byte[] GPMF_BYTES =
            new byte[] {
                0x00,
                0x00,
                0x04,
                (byte) 0xe0,
                0x47,
                0x50,
                0x4d,
                0x46,
                0x44,
                0x45,
                0x56,
                0x43,
                0x00,
                0x01,
                0x03,
                (byte) 0x9c,
                0x44,
                0x56,
                0x49,
                0x44,
                0x4c,
                0x04,
                0x00,
                0x01,
                0x00,
                0x00,
                0x00,
                0x01,
                0x44,
                0x56,
                0x4e,
                0x4d,
                0x63,
                0x0f,
                0x00,
                0x01,
                0x47,
                0x6c,
                0x6f,
                0x62,
                0x61,
                0x6c,
                0x20,
                0x53,
                0x65,
                0x74,
                0x74,
                0x69,
                0x6e,
                0x67,
                0x73,
                0x00,
                0x56, // offset 52
                0x45,
                0x52,
                0x53,
                0x42,
                0x01,
                0x00,
                0x03,
                0x08,
                0x02,
                0x00,
                0x00,
                0x46,
                0x4d,
                0x57,
                0x52,
                0x63,
                0x01,
                0x00,
                0x0f,
                0x48,
                0x32,
                0x32,
                0x2e,
                0x30,
                0x31,
                0x2e,
                0x30,
                0x31,
                0x2e,
                0x30,
                0x39,
                0x2e,
                0x32,
                0x33,
                0x00,
                0x4c,
                0x49,
                0x4e,
                0x46,
                0x63,
                0x01,
                0x00,
                0x10,
                0x4c,
                0x53,
                0x55,
                0x32,
                0x30,
                0x35,
                0x33,
                0x30,
                0x30,
                0x34,
                0x34,
                0x30,
                0x31,
                0x36,
                0x31,
                0x33,
                0x43,
                0x49,
                0x4e,
                0x46,
                0x42,
                0x01,
                0x00,
                0x10,
                0x18,
                0x50,
                (byte) 0xaa,
                (byte) 0xf3,
                0x5a,
                0x4e,
                (byte) 0xeb,
                0x11,
                (byte) 0x81,
                0x56,
                0x14,
                0x38,
                (byte) 0x8f,
                0x63,
                (byte) 0x9c,
                0x13,
                0x43,
                0x41,
                0x53,
                0x4e,
                0x63,
                0x01,
                0x00,
                0x0f,
                0x43,
                0x33,
                0x34,
                0x37,
                0x31,
                0x33,
                0x32,
                0x34,
                0x35,
                0x30,
                0x31,
                0x33,
                0x32,
                0x30,
                0x00,
                0x00, // 159
                0x4d,
                0x49,
                0x4e,
                0x46,
                0x63,
                0x01,
                0x00,
                0x1e,
                0x48,
                0x45,
                0x52,
                0x4f,
                0x31,
                0x31,
                0x20,
                0x42,
                0x6c,
                0x61,
                0x63,
                0x6b,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x4d,
                0x55,
                0x49,
                0x44,
                0x4c,
                0x04,
                0x00,
                0x08,
                (byte) 0xf3,
                (byte) 0xaa,
                0x50,
                0x18,
                0x11,
                (byte) 0xeb,
                0x4e,
                0x5a,
                0x38,
                0x14,
                0x56,
                (byte) 0x81,
                0x13,
                (byte) 0x9c,
                0x63,
                (byte) 0x8f,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x43,
                0x4d,
                0x4f,
                0x44,
                0x42,
                0x01,
                0x00,
                0x01,
                0x0c,
                0x00,
                0x00,
                0x00,
                0x4d,
                0x54,
                0x59,
                0x50,
                0x42,
                0x01,
                0x00,
                0x01,
                0x00,
                0x00,
                0x00,
                0x00,
                0x4f,
                0x52,
                0x45,
                0x4e,
                0x63,
                0x01,
                0x00,
                0x01,
                0x55,
                0x00,
                0x00,
                0x00,
                0x44,
                0x5a,
                0x4f,
                0x4d,
                0x63,
                0x01,
                0x00,
                0x01,
                0x59,
                0x00,
                0x00,
                0x00,
                0x44,
                0x5a,
                0x53,
                0x54,
                0x4c,
                0x04,
                0x00,
                0x01,
                0x00,
                0x00,
                0x00,
                0x00,
                0x53,
                0x4d,
                0x54,
                0x52,
                0x63,
                0x01,
                0x00,
                0x01,
                0x4e,
                0x00,
                0x00,
                0x00,
                0x50,
                0x52,
                0x54,
                0x4e,
                0x63,
                0x01,
                0x00,
                0x01,
                0x59,
                0x00,
                0x00,
                0x00,
                0x50,
                0x54,
                0x57,
                0x42,
                0x63,
                0x01,
                0x00,
                0x08,
                0x41,
                0x55,
                0x54,
                0x4f,
                0x00,
                0x00,
                0x00,
                0x00,
                0x50,
                0x54,
                0x53,
                0x48,
                0x63,
                0x01,
                0x00,
                0x06,
                0x4d,
                0x45,
                0x44,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x50,
                0x54,
                0x43,
                0x4c,
                0x63,
                0x01,
                0x00,
                0x08,
                0x4e,
                0x41,
                0x54,
                0x55,
                0x52,
                0x41,
                0x4c,
                0x00,
                0x45,
                0x58,
                0x50,
                0x54,
                0x63,
                0x01,
                0x00,
                0x0b,
                0x41,
                0x55,
                0x54,
                0x4f,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x50,
                0x49,
                0x4d,
                0x58,
                0x4c,
                0x04,
                0x00,
                0x01,
                0x00,
                0x00,
                0x06,
                0x40,
                0x50,
                0x49,
                0x4d,
                0x4e,
                0x4c,
                0x04,
                0x00,
                0x01,
                0x00,
                0x00,
                0x00,
                0x64,
                0x50,
                0x54,
                0x45,
                0x56,
                0x63,
                0x01,
                0x00,
                0x06,
                0x30,
                0x2e,
                0x30,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x52,
                0x41,
                0x54,
                0x45,
                0x63,
                0x01,
                0x00,
                0x09,
                0x00,
                0x00, // element 441 - was 0x55
                0x00, // element 442 - was 0x54
                0x00, // element 443 - was 0x4f
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x53,
                0x52,
                0x4f,
                0x54,
                0x66,
                0x04,
                0x00,
                0x01,
                0x41,
                (byte) 0xa0,
                0x00,
                0x00,
                0x45,
                0x49,
                0x53,
                0x45,
                0x63,
                0x01,
                0x00,
                0x01,
                0x59,
                0x00,
                0x00,
                0x00,
                0x45,
                0x49,
                0x53,
                0x41,
                0x63,
                0x01,
                0x00,
                0x0e,
                0x48,
                0x53,
                0x20,
                0x45,
                0x49,
                0x53,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x48,
                0x43,
                0x54,
                0x4c,
                0x63,
                0x01,
                0x00,
                0x07,
                0x4f,
                0x66,
                0x66,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x41,
                0x55,
                0x50,
                0x54,
                0x63,
                0x01,
                0x00,
                0x01,
                0x4e,
                0x00,
                0x00,
                0x00,
                0x41,
                0x55,
                0x44,
                0x4f,
                0x63,
                0x01,
                0x00,
                0x08,
                0x41,
                0x55,
                0x54,
                0x4f,
                0x00,
                0x00,
                0x00,
                0x00,
                0x42,
                0x52,
                0x4f,
                0x44,
                0x63,
                0x01,
                0x00,
                0x08,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x42,
                0x52,
                0x49,
                0x44,
                0x42,
                0x01,
                0x00,
                0x01,
                0x00,
                0x00,
                0x00,
                0x00,
                0x50,
                0x56,
                0x55,
                0x4c,
                0x63,
                0x01,
                0x00,
                0x08,
                0x46,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x50,
                0x52,
                0x4a,
                0x54,
                0x46,
                0x04,
                0x00,
                0x01,
                0x47,
                0x50,
                0x52,
                0x4f,
                0x53,
                0x4f,
                0x46,
                0x46,
                0x4c,
                0x04,
                0x00,
                0x01,
                0x00,
                0x00,
                0x00,
                0x00,
                0x43,
                0x4c,
                0x4b,
                0x53,
                0x42,
                0x01,
                0x00,
                0x01,
                0x02,
                0x00,
                0x00,
                0x00,
                0x43,
                0x44,
                0x41,
                0x54,
                0x4a,
                0x08,
                0x00,
                0x01,
                0x00,
                0x00,
                0x00,
                0x00,
                0x63,
                0x12,
                0x7d,
                0x36,
                0x53,
                0x43,
                0x54,
                0x4d,
                0x4c,
                0x04,
                0x00,
                0x01,
                0x00,
                0x00,
                0x00,
                0x00,
                0x50,
                0x52,
                0x4e,
                0x41,
                0x42,
                0x01,
                0x00,
                0x01,
                0x01,
                0x00,
                0x00,
                0x00,
                0x50,
                0x52,
                0x4e,
                0x55,
                0x42,
                0x01,
                0x00,
                0x01,
                0x00,
                0x00,
                0x00,
                0x00,
                0x53,
                0x43,
                0x41,
                0x50,
                0x63,
                0x01,
                0x00,
                0x01,
                0x4e,
                0x00,
                0x00,
                0x00,
                0x43,
                0x44,
                0x54,
                0x4d,
                0x4c,
                0x04,
                0x00,
                0x01,
                0x00,
                0x00,
                0x00,
                0x00,
                0x44,
                0x55,
                0x53,
                0x54,
                0x63,
                0x01,
                0x00,
                0x09,
                0x4e,
                0x4f,
                0x5f,
                0x4c,
                0x49,
                0x4d,
                0x49,
                0x54,
                0x00,
                0x00,
                0x00,
                0x00,
                0x56,
                0x52,
                0x45,
                0x53,
                0x4c,
                0x04,
                0x00,
                0x02,
                0x00,
                0x00,
                0x14,
                (byte) 0xc0,
                0x00,
                0x00,
                0x0b,
                (byte) 0xac,
                0x56,
                0x46,
                0x50,
                0x53,
                0x4c,
                0x04,
                0x00,
                0x02,
                0x00,
                0x00,
                0x75,
                0x30,
                0x00,
                0x00,
                0x03,
                (byte) 0xe9,
                0x48,
                0x53,
                0x47,
                0x54,
                0x63,
                0x01,
                0x00,
                0x06,
                0x4f,
                0x46,
                0x46,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x42,
                0x49,
                0x54,
                0x52,
                0x63,
                0x01,
                0x00,
                0x09,
                0x53,
                0x54,
                0x41,
                0x4e,
                0x44,
                0x41,
                0x52,
                0x44,
                0x00,
                0x00,
                0x00,
                0x00,
                0x4d,
                0x4d,
                0x4f,
                0x44,
                0x63,
                0x01,
                0x00,
                0x09,
                0x53,
                0x54,
                0x45,
                0x52,
                0x45,
                0x4f,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x52,
                0x41,
                0x4d,
                0x50,
                0x63,
                0x01,
                0x00,
                0x0b,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x54,
                0x5a,
                0x4f,
                0x4e,
                0x73,
                0x02,
                0x00,
                0x01,
                0x00,
                0x78,
                0x00,
                0x00,
                0x43,
                0x4c,
                0x4b,
                0x43,
                0x4c,
                0x04,
                0x00,
                0x01,
                0x00,
                0x00,
                0x00,
                0x00,
                0x44,
                0x5a,
                0x4d,
                0x58,
                0x66,
                0x04,
                0x00,
                0x01,
                0x3f,
                (byte) 0xb3,
                0x33,
                0x33,
                0x43,
                0x54,
                0x52,
                0x4c,
                0x63,
                0x01,
                0x00,
                0x05,
                0x50,
                0x72,
                0x6f,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x50,
                0x57,
                0x50,
                0x52,
                0x63,
                0x01,
                0x00,
                0x0c,
                0x50,
                0x45,
                0x52,
                0x46,
                0x4f,
                0x52,
                0x4d,
                0x41,
                0x4e,
                0x43,
                0x45,
                0x00,
                0x4f,
                0x52,
                0x44,
                0x50,
                0x63,
                0x01,
                0x00,
                0x01,
                0x59,
                0x00,
                0x00,
                0x00,
                0x43,
                0x4c,
                0x44,
                0x50,
                0x63,
                0x01,
                0x00,
                0x01,
                0x59,
                0x00,
                0x00,
                0x00,
                0x50,
                0x49,
                0x4d,
                0x44,
                0x63,
                0x01,
                0x00,
                0x07,
                0x4d,
                0x41,
                0x4e,
                0x55,
                0x41,
                0x4c,
                0x00,
                0x00,
                0x44,
                0x45,
                0x56,
                0x43,
                0x00,
                0x01,
                0x01,
                0x04,
                0x44,
                0x56,
                0x49,
                0x44,
                0x46,
                0x04,
                0x00,
                0x01,
                0x46,
                0x4f,
                0x56,
                0x4c,
                0x44,
                0x56,
                0x4e,
                0x4d,
                0x63,
                0x09,
                0x00,
                0x01,
                0x4c,
                0x61,
                0x72,
                0x67,
                0x65,
                0x20,
                0x46,
                0x4f,
                0x56,
                0x00,
                0x00,
                0x00,
                0x41,
                0x42,
                0x53,
                0x43,
                0x66,
                0x04,
                0x00,
                0x01,
                0x00,
                0x00,
                0x00,
                0x00,
                0x5a,
                0x46,
                0x4f,
                0x56,
                0x66,
                0x04,
                0x00,
                0x01,
                0x42,
                (byte) 0xf7,
                0x4a,
                (byte) 0x9c,
                0x56,
                0x46,
                0x4f,
                0x56,
                0x63,
                0x01,
                0x00,
                0x01,
                0x57,
                0x00,
                0x00,
                0x00,
                0x4d,
                0x58,
                0x43,
                0x46,
                0x63,
                0x08,
                0x00,
                0x01,
                0x78,
                0x31,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x4d,
                0x41,
                0x50,
                0x58,
                0x66,
                0x04,
                0x00,
                0x01,
                0x3f,
                (byte) 0x80,
                0x00,
                0x00,
                0x4d,
                0x59,
                0x43,
                0x46,
                0x63,
                0x08,
                0x00,
                0x01,
                0x79,
                0x31,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x4d,
                0x41,
                0x50,
                0x59,
                0x66,
                0x04,
                0x00,
                0x01,
                0x3f,
                (byte) 0x80,
                0x00,
                0x00,
                0x50,
                0x59,
                0x43,
                0x46,
                0x63,
                0x08,
                0x00,
                0x07,
                0x72,
                0x30,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x72,
                0x31, // offset 1089
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x72,
                0x32,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x72,
                0x33,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x72,
                0x34,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x72,
                0x35,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x72,
                0x36,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x50,
                0x4f,
                0x4c,
                0x59,
                0x66,
                0x1c,
                0x00,
                0x01,
                0x00,
                0x00,
                0x00,
                0x00,
                0x3f,
                (byte) 0xe8,
                0x56,
                0x29,
                0x3d,
                (byte) 0xd8,
                (byte) 0xdf,
                0x54,
                (byte) 0xbf,
                0x27,
                (byte) 0x99,
                0x63,
                0x3e,
                (byte) 0xb3,
                0x51,
                (byte) 0xc6,
                (byte) 0xa9,
                (byte) 0xec,
                (byte) 0xc8,
                0x14,
                0x29,
                0x46,
                (byte) 0xe0,
                (byte) 0xe9,
                0x5a,
                0x4d,
                0x50,
                0x4c,
                0x66,
                0x04,
                0x00,
                0x01,
                0x3f,
                0x21,
                (byte) 0xa6,
                0x66,
                0x41,
                0x52,
                0x55,
                0x57,
                0x66,
                0x04,
                0x00,
                0x01,
                0x3f,
                (byte) 0xe3,
                (byte) 0x8e,
                0x39,
                0x41,
                0x52,
                0x57,
                0x41,
                0x66,
                0x04,
                0x00,
                0x01,
                0x3f,
                (byte) 0xe3,
                (byte) 0x8e,
                0x39,
                0x44,
                0x45,
                0x56,
                0x43,
                0x00,
                0x01,
                0x00,
                0x20,
                0x44,
                0x56,
                0x49,
                0x44,
                0x46,
                0x04,
                0x00,
                0x01,
                0x48,
                0x4c,
                0x4d,
                0x54,
                0x44,
                0x56,
                0x4e,
                0x4d,
                0x63,
                0x0a,
                0x00,
                0x01,
                0x48,
                0x69,
                0x67,
                0x68,
                0x6c,
                0x69,
                0x67,
                0x68,
                0x74,
                0x73,
                0x00,
                0x00
            };

    /*
    @Test
        public void checkWrite() throws IOException {
            TrackGroupBox box =
                    new TrackGroupBoxBuilder()
                            .withGroup(new TrackGroupTypeBox(TrackGroupType.MSRC, 32911))
                            .build();
            ByteArrayOutputStream baos = new ByteArrayOutputStream();
            OutputStreamWriter streamWriter = new OutputStreamWriter(baos);
            box.writeTo(streamWriter);
            byte[] bytes = baos.toByteArray();
            assertEquals(bytes, TRGR_BYTES);
            File testTref = new File("trgr.bin");
            Files.write(testTref.toPath(), bytes, StandardOpenOption.CREATE);
            assertTrue(box.toString().startsWith("TrackGroupBox 'trgr' : group count=1"));
            assertTrue(box.toString().endsWith("group_type=msrc, track_group_id=32911"));
        }
    */

    @Test
    public void checkParse() throws IOException {
        ByteArrayParser parser = new ByteArrayParser();
        List<Box> boxes = parser.parse(GPMF_BYTES);
        assertEquals(boxes.size(), 1);
        Box box = boxes.get(0);
        assertTrue(box instanceof GPMF);
        GPMF gpmf = (GPMF) box;
        assertTrue(gpmf.getFourCC().toString().equals("GPMF"));
        // TODO: check entries
        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        OutputStreamWriter streamWriter = new OutputStreamWriter(baos);
        box.writeTo(streamWriter);
        byte[] bytes = baos.toByteArray();
        assertEquals(bytes, GPMF_BYTES);
    }
}
